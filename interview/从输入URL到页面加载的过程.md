# 从输入URL到页面加载的过程

## 对知识体系的评级
#### level1：
完全没有什么概念，大概如下回答：
* 浏览器发起请求，服务端返回数据，然后前端解析成网页，执行脚本。。。
#### level2：
已经有初步概念，但是没有完整梳理过，导致无法形成一个完整的体系，或者是很多细节都不会展开，大概如下回答：
* 知道浏览器输入url后会有http请求这个概念
* 有后台这个概念，大致知道前后端的交互，知道前后端主要靠http报文通信
* 知道浏览器接收到数据后会进行解析，有一定概念，但是具体流程不熟悉（如render树构建流程，layout、paint，复合层与简单层，常用优化方案等不是很熟悉）
* 对于js引擎的解析流程有一定概念，但是细节不熟悉（如具体的形参，函数，变量提升，执行上下文以及VO、AO、作用域链，回收机制等概念不是很熟悉）
* 可能知道一些http规范初步概念，但是不熟悉（如http报文结构，常用头部，缓存机制，http2.0，https等特性，跨域与web安全等不是很熟悉）
#### level3：
基本能到这一步的，不是高阶就是接近高阶，因为很多概念并不是靠背就能理解的，而是要理解这么多，需形成体系，一般需要积累，非一日之功。
大概如下回答：
* 首先略去那些键盘输入和操作系统交互、以及屏幕显示原理、网卡等硬件交互之类的（前端向中，很多硬件原理暂时略去）
* 对浏览器模型有整体概念，知道浏览器是多进程的，浏览器内核是多线程的，清楚进程与线程之间的区别，以及输入url后会开一个新的网络线程
* 对于开启网络线程到发出一个完整的http请求中间的过程有所了解（如dns查询，tcp/ip连接，五层因特网协议栈等等，以及一些优化方案，如dns-prefetch）
* 对从服务器接收到请求到对应后台接收到请求有一定了解（如负载均衡，安全拦截以及后台代码处理等）
* 对后台和前台的http交互熟悉（包括http报文结构，场景头部，cookie，跨域，web安全，http缓存，http2.0，https等）
* 对浏览器接收到http数据包后的解析流程熟悉（包括解析html，词法分析然后解析成dom树、解析css生成css规则树、合并成render树，然后layou、painting渲染、里面可能还包括复合图层的合成、GPU绘制、外链处理、加载顺序等）
* 对js引擎解析过程熟悉（包括js的解释，预处理，执行上下文，VO，作用域链，this，回收机制等）
#### level4：
大概会有如下回答（猜的）：
* 从键盘谈到系统交互，从浏览器到CPU，从调度机制到系统内核，从数据请求到二进制、汇编，从GPU绘图到LCD显示，然后在分析系统底层的进程、内存等等。

## 梳理主干流程
知识体系中，最重要的就是骨架，脉络。有了骨架后才方便填充细节。所有先梳理下主干流程：
1. 从浏览器接收url到开启网络请求线程（这一部分可以展开浏览器的机制以及展开浏览器的机制以及进程与线程之间的关系）
2. 开启网络线程到发出一个完整的http请求（这一部分涉及到dns查询，tcp/ip请求，五层因特网协议栈等知识）
3. 从服务器接收到请求到对应后台接收到请求（这一部分可能涉及到负载均衡，安全拦截以及后台内部的处理等等）
4. 后台和前台的http交互（这一部分包括头部、响应码、报文结构、cookie等知识，可以提下静态资源的cookie优化，以及编码解码，如gzip压缩等）
5. 单独拎出来的缓存问题，http的缓存（这部分包括http缓存头部，etag，catch-control等）
6. 浏览器接收到http数据包后的解析流程（解析html-词法分析然后解析成dom树、解析css生层css规则树、合成render树，然后layout、painting渲染、复合图层的合成、GPU绘制、外链资源的处理、loaded和domcontentloaded等）
7. CSS的可视化格式模型（元素的渲染规则，如包含块，控制框，BFC，IFC等概念）
8. JS引擎解析过程（JS的解释阶段，预处理阶段，执行阶段生成执行上下文，VO，作用域链、回收机制等等）
9. 其他（可以拓展不同的知识模块，如跨域，web安全，hybrid模式等等内容）
梳理出主干骨架，然后就需要往骨架上填充细节内容

## 从浏览器接收url到开启网络请求线程
这一部分展开的内容是：浏览器进程/线程模型，JS的运行机制

### 多进程的浏览器
浏览器是多进程的，有一个主控进程，以及每一个tab页面都会新开一个进程（某些情况下多个会合并进程）
进程可能包括主控进程，插件进程，GPU，tab页（浏览器内核）等等
* Browser进程：浏览器的主进程（负责协调、主控），只有一个
* 第三方插件进程：没中类型的插件对应一个进程，仅当使用该插件时才会创建
* GPU进程：最多一个，用于3D绘制
* 浏览器渲染进程（内核）：默认每个tab页面一个进程，互不影响，控制页面渲染，脚本执行，时间处理等（有时候会优化，如多个空白tab会合并成一个进程）
  
如下图：
![browser](./images/browser.png)

### 多线程的浏览器内核
每个tab页面可以看作是浏览器内核进程，然后这个进程是多线程的，它有几大类子线程
* GUI线程
* JS引擎线程
* 事件触发线程
* 定时器线程
* 网络请求线程
  
![browser_kernel](./images/browser_kernel.png)
可以看到，里面的JS引擎是内核进程中的一个线程，这也是为什么常说JS引擎是单线程的

### 解析URL
输入URL后，会进行解析（URL的本质就是统一资源定位符）
URL一般包括几大部分：
* `protocol`，协议头，譬如有http，ftpdeng
* `host`，主机域名或IP地址
* `port`，端口号
* `path`，目录路径
* `query`，查询参数
* `fragment`，即`#`后的hash值，一般用来定位到某个位置

### 网络请求都是单独的线程
每次网络请求时都需要开辟单独的线程进行，譬如如果URL解析到http协议，就会新建一个网络线程去处理资源下载，因此浏览器会根据解析出得协议，开辟一个网络线程，前往请求资源（这里，暂时理解为时浏览器内核开辟的，如有错误，后续修复）
